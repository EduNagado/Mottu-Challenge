# =====================================================
# Azure DevOps Pipeline - Gef Mottu API
# CI/CD com Docker + Deploy no Azure Web App for Containers
# =====================================================

trigger:
  branches:
    include:
      - master

variables:
  - group: 'variaveis-segredas'   # grupo com credenciais e secrets
  - name: appName
    value: 'gefmottu-api'
  - name: acrName
    value: 'gefmottuacr'
  - name: imageName
    value: 'gefmottu-api'
  - name: tag
    value: '$(Build.BuildId)'
  - name: resourceGroup
    value: 'gef-mottu-dev-rg'
  - name: location
    value: 'brazilsouth'
  - name: appServicePlan
    value: 'gef-mottu-plan'

stages:
  # -----------------------
  # ðŸ§± Stage 1 - Build + Push Docker Image
  # -----------------------
  - stage: Build
    displayName: 'Build da imagem Docker e Push no ACR'
    jobs:
      - job: BuildAndPush
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Login no Azure e criar ACR se nÃ£o existir'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                EXIST=$(az acr show -n $(acrName) --query "name" -o tsv 2>/dev/null || echo "")
                if [ -z "$EXIST" ]; then
                  echo "ACR nÃ£o existe. Criando..."
                  az acr create \
                    --name $(acrName) \
                    --resource-group $(resourceGroup) \
                    --sku Standard \
                    --location $(location) \
                    --admin-enabled true
                else
                  echo "ACR jÃ¡ existe."
                fi
                az acr login --name $(acrName)

          - script: |
              docker build -t $(acrName).azurecr.io/$(imageName):$(tag) .
              docker push $(acrName).azurecr.io/$(imageName):$(tag)
            displayName: 'Build e Push da imagem Docker'

          - publish: $(System.DefaultWorkingDirectory)
            artifact: drop

  # -----------------------
  # ðŸš€ Stage 2 - Deploy + Teste de API
  # -----------------------
  - stage: Deploy
    displayName: 'Deploy no Azure Web App e Testes de API'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployWebApp
        environment: 'dev'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Criar Resource Group e App Service Plan se nÃ£o existirem'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      RG=$(az group show -n $(resourceGroup) --query "name" -o tsv 2>/dev/null || echo "")
                      if [ -z "$RG" ]; then
                        echo "Criando Resource Group..."
                        az group create --name $(resourceGroup) --location $(location)
                      else
                        echo "Resource Group jÃ¡ existe."
                      fi

                      PLAN=$(az appservice plan show --name $(appServicePlan) --resource-group $(resourceGroup) --query "name" -o tsv 2>/dev/null || echo "")
                      if [ -z "$PLAN" ]; then
                        echo "Criando App Service Plan..."
                        az appservice plan create --name $(appServicePlan) --resource-group $(resourceGroup) --sku B1 --is-linux
                      else
                        echo "App Service Plan jÃ¡ existe."
                      fi

                - task: AzureCLI@2
                  displayName: 'Criar Web App se nÃ£o existir ou atualizar imagem'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      APP=$(az webapp show --name $(appName) --resource-group $(resourceGroup) --query "name" -o tsv 2>/dev/null || echo "")
                      if [ -z "$APP" ]; then
                        echo "Criando Web App..."
                        az webapp create \
                          --resource-group $(resourceGroup) \
                          --plan $(appServicePlan) \
                          --name $(appName) \
                          --deployment-container-image-name $(acrName).azurecr.io/$(imageName):$(tag)
                      else
                        echo "Web App jÃ¡ existe. Atualizando imagem..."
                        az webapp config container set \
                          --name $(appName) \
                          --resource-group $(resourceGroup) \
                          --docker-custom-image-name $(acrName).azurecr.io/$(imageName):$(tag)
                      fi

                - task: AzureCLI@2
                  displayName: 'Reiniciar Web App'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Reiniciando Web App..."
                      az webapp restart --name $(appName) --resource-group $(resourceGroup)

                # ðŸ§ª Testes de API
                - task: CmdLine@2
                  displayName: 'Executar Testes de API'
                  inputs:
                    script: |
                      echo "=== INICIANDO TESTES DE API ==="
                      API_URL="https://gefmottu-api.azurewebsites.net"
                      echo "Testing application at: $API_URL"

                      echo "Testing Swagger UI..."
                      SWAGGER_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/swagger-ui/swagger-ui/index.html" || echo "000")
                      if [ "$SWAGGER_RESPONSE" -eq 200 ]; then
                          echo "SUCCESS: Swagger UI - HTTP $SWAGGER_RESPONSE"
                      else
                          echo "FAILED: Swagger UI - HTTP $SWAGGER_RESPONSE"
                          exit 1
                      fi

                      echo "Testing API Docs..."
                      API_DOCS_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/v3/api-docs" || echo "000")
                      if [ "$API_DOCS_RESPONSE" -eq 200 ]; then
                          echo "SUCCESS: API Docs - HTTP $API_DOCS_RESPONSE"
                          curl -s "$API_URL/v3/api-docs" | grep -o '"tags":\[[^]]*\]' | head -3
                      else
                          echo "FAILED: API Docs - HTTP $API_DOCS_RESPONSE"
                          exit 1
                      fi

                      echo "Testing POST /usuarios..."
                      CLIENTE_RESPONSE=$(curl -s -o response.json -w "%{http_code}" \
                        -X POST "$API_URL/usuarios" \
                        -H "accept: application/json" \
                        -H "Content-Type: application/json" \
                        -d '{
                          "nome": "Henrique Strapazzon",
                          "email": "henrique.strapazzon@gmail.com",
                          "password": "henrique123",
                          "cpf": "40660129817",
                          "cargo": "ADMINISTRADOR"
                        }')

                      echo "POST /usuarios HTTP Response: $CLIENTE_RESPONSE"

                      if [ "$CLIENTE_RESPONSE" -eq 201 ] || [ "$CLIENTE_RESPONSE" -eq 200 ]; then
                          echo "SUCCESS: POST /usuarios - HTTP $CLIENTE_RESPONSE"
                          cat response.json
                      else
                          echo "INFO: POST /usuarios - HTTP $CLIENTE_RESPONSE (validation or conflict)"
                          cat response.json
                      fi

                      rm -f response.json
                      echo "=== TODOS OS TESTES FORAM EXECUTADOS COM SUCESSO ==="
