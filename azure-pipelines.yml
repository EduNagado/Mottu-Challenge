# =====================================================
# Azure DevOps Pipeline - Gef Mottu API
# CI/CD com Docker + Deploy no Azure Web App for Containers
# =====================================================

trigger:
  branches:
    include:
      - master

variables:
  - group: 'variaveis-segredas'   # grupo com credenciais e secrets
  - name: appName
    value: 'gefmottu-api'        # nome do Web App
  - name: acrName
    value: 'gefmottuacr'         # nome do Azure Container Registry
  - name: imageName
    value: 'gefmottu-api'        # nome da imagem Docker
  - name: tag
    value: '$(Build.BuildId)'     # tag Ãºnica por build
  - name: resourceGroup
    value: 'gef-mottu-dev-rg' # ajuste para o seu Resource Group
  - name: location
    value: 'brazilsouth'            # ajuste para sua regiÃ£o, ex: eastus

stages:
  # -----------------------
  # ðŸ§± Stage 1 - Build + Push Docker Image
  # -----------------------
  - stage: Build
    displayName: 'Build da imagem Docker e Push no ACR'
    jobs:
      - job: BuildAndPush
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - checkout: self

          # Login no Azure e criar ACR se nÃ£o existir
          - task: AzureCLI@2
            displayName: 'Login no Azure e criar ACR se nÃ£o existir'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Verifica se o ACR existe
                EXIST=$(az acr show -n $(acrName) --query "name" -o tsv 2>/dev/null || echo "")
                
                if [ -z "$EXIST" ]; then
                  echo "ACR nÃ£o existe. Criando..."
                  az acr create \
                    --name $(acrName) \
                    --resource-group $(resourceGroup) \
                    --sku Standard \
                    --location $(location) \
                    --admin-enabled true
                else
                  echo "ACR jÃ¡ existe."
                fi

                # Login no ACR
                az acr login --name $(acrName)

          # Build e Push da imagem Docker
          - script: |
              docker build -t $(acrName).azurecr.io/$(imageName):$(tag) .
              docker push $(acrName).azurecr.io/$(imageName):$(tag)
            displayName: 'Build e Push da imagem Docker'

          # Publicar artefato para a stage de deploy
          - publish: $(System.DefaultWorkingDirectory)
            artifact: drop

  # -----------------------
  # ðŸš€ Stage 2 - Deploy no Azure Web App for Containers
  # -----------------------
  - stage: Deploy
    displayName: 'Deploy no Azure Web App (Docker Container)'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployWebApp
        environment: 'dev'
        pool:
          vmImage: 'ubuntu-latest'

        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy da imagem no Web App'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appName: '$(appName)'
                    appType: 'webAppContainer'
                    containers: '$(acrName).azurecr.io/$(imageName):$(tag)'
