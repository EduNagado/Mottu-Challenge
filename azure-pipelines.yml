# =====================================================
# Azure DevOps Pipeline - Gef Mottu API
# CI/CD com Docker + Deploy no Azure Web App for Containers
# Com suporte a slots (staging e production)
# =====================================================

trigger:
  branches:
    include:
      - master

variables:
  - group: 'variaveis-segredas'
  - name: appName
    value: 'gefmottu-api'
  - name: acrName
    value: 'gefmottuacr'
  - name: imageName
    value: 'gefmottu-api'
  - name: tag
    value: '$(Build.BuildId)'
  - name: resourceGroup
    value: 'gef-mottu-dev-rg'
  - name: location
    value: 'brazilsouth'
  - name: appServicePlan
    value: 'gef-mottu-plan'
  - name: stagingSlot
    value: 'staging'

stages:
  # -----------------------
  # ðŸ§± Stage 1 - Build + Push Docker Image
  # -----------------------
  - stage: Build
    displayName: 'Build da imagem Docker e Push no ACR'
    jobs:
      - job: BuildAndPush
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Login no Azure e criar ACR se nÃ£o existir'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                EXIST=$(az acr show -n $(acrName) --query "name" -o tsv 2>/dev/null || echo "")
                if [ -z "$EXIST" ]; then
                  az acr create --name $(acrName) --resource-group $(resourceGroup) --sku Standard --location $(location) --admin-enabled true
                fi
                az acr login --name $(acrName)

          - script: |
              docker build -t $(acrName).azurecr.io/$(imageName):$(tag) .
              docker push $(acrName).azurecr.io/$(imageName):$(tag)
            displayName: 'Build e Push da imagem Docker'

          - publish: $(System.DefaultWorkingDirectory)
            artifact: drop

  # -----------------------
  # ðŸš€ Stage 2 - Deploy no slot staging
  # -----------------------
  - stage: DeployStaging
    displayName: 'Deploy no slot staging'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployStaging
        environment: 'staging'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Criar RG, App Service Plan e Web App se nÃ£o existirem'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Resource Group
                      RG=$(az group show -n $(resourceGroup) --query "name" -o tsv 2>/dev/null || echo "")
                      if [ -z "$RG" ]; then
                        az group create --name $(resourceGroup) --location $(location)
                      fi
                      # App Service Plan
                      PLAN=$(az appservice plan show --name $(appServicePlan) --resource-group $(resourceGroup) --query "name" -o tsv 2>/dev/null || echo "")
                      if [ -z "$PLAN" ]; then
                        az appservice plan create --name $(appServicePlan) --resource-group $(resourceGroup) --sku B1 --is-linux
                      fi
                      # Web App
                      APP=$(az webapp show --name $(appName) --resource-group $(resourceGroup) --query "name" -o tsv 2>/dev/null || echo "")
                      if [ -z "$APP" ]; then
                        az webapp create --resource-group $(resourceGroup) --plan $(appServicePlan) --name $(appName) --deployment-container-image-name $(acrName).azurecr.io/$(imageName):$(tag)
                      fi
                      # Slot staging
                      SLOT=$(az webapp deployment slot show --name $(appName) --resource-group $(resourceGroup) --slot $(stagingSlot) --query "name" -o tsv 2>/dev/null || echo "")
                      if [ -z "$SLOT" ]; then
                        az webapp deployment slot create --name $(appName) --resource-group $(resourceGroup) --slot $(stagingSlot)
                      fi

                - task: AzureCLI@2
                  displayName: 'Deploy da imagem no slot staging'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az webapp config container set --name $(appName) --resource-group $(resourceGroup) --slot $(stagingSlot) --docker-custom-image-name $(acrName).azurecr.io/$(imageName):$(tag)
                      az webapp restart --name $(appName) --resource-group $(resourceGroup) --slot $(stagingSlot)

  # -----------------------
  # ðŸ”„ Stage 3 - Swap staging -> production
  # -----------------------
  - stage: SwapToProduction
    displayName: 'Swap slot staging -> production'
    dependsOn: DeployStaging
    condition: succeeded()
    jobs:
      - job: Swap
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: 'Realizar swap staging -> production'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az webapp deployment slot swap --name $(appName) --resource-group $(resourceGroup) --slot $(stagingSlot)
